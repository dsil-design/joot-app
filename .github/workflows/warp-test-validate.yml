name: "🧪 Test & Validate"

on:
  workflow_dispatch:
    inputs:
      run_all_tests:
        description: 'Run all test suites (unit, integration, e2e)'
        required: false
        default: false
        type: boolean
      coverage_required:
        description: 'Require minimum test coverage'
        required: false
        default: true
        type: boolean

jobs:
  validate:
    name: "Validate Code Quality"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: TypeScript compilation check
        run: |
          echo "🔍 Checking TypeScript compilation..."
          npx tsc --noEmit
          echo "✅ TypeScript compilation passed"
        
      - name: ESLint code quality check
        run: |
          echo "🔍 Running ESLint checks..."
          npm run lint
          echo "✅ Code quality checks passed"
      
      - name: Build verification
        run: |
          echo "🔍 Testing production build..."
          npm run build
          echo "✅ Production build successful"
        env:
          NEXT_PUBLIC_SUPABASE_URL: https://dummy.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: dummy-key
          SUPABASE_SERVICE_ROLE_KEY: dummy-service-key
          NODE_ENV: test
      
      - name: Unit tests
        run: |
          echo "🔍 Running unit tests..."
          npm run test:unit
          echo "✅ Unit tests passed"
        env:
          NEXT_PUBLIC_SUPABASE_URL: https://dummy.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: dummy-key

      - name: Test coverage check
        if: ${{ inputs.coverage_required }}
        run: |
          echo "🔍 Checking test coverage requirements..."
          npm run test:coverage
          echo "✅ Coverage requirements met"
        env:
          NEXT_PUBLIC_SUPABASE_URL: https://dummy.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: dummy-key

      - name: Full test suite
        if: ${{ inputs.run_all_tests }}
        run: |
          echo "🔍 Running comprehensive test suite..."
          npm run test:all
          echo "✅ All tests passed"
        env:
          NEXT_PUBLIC_SUPABASE_URL: https://dummy.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: dummy-key

      - name: Validation Summary
        run: |
          echo "🧪 Code Validation Complete!"
          echo "✅ TypeScript compilation verified"
          echo "✅ Code quality checks passed"  
          echo "✅ Production build successful"
          echo "✅ Unit tests passed"
          echo ""
          echo "🎯 Your AI-generated code is ready for deployment!"
          echo "Next steps:"
          echo "1. 🗄️ Deploy database changes (if any)"
          echo "2. 🚀 Deploy to production"
