name: "ğŸ§ª Test & Validate"

on:
  workflow_dispatch:
    inputs:
      run_all_tests:
        description: 'Run all test suites (unit, integration, e2e)'
        required: false
        default: false
        type: boolean
      coverage_required:
        description: 'Require minimum test coverage'
        required: false
        default: true
        type: boolean

jobs:
  validate:
    name: "Validate Code Quality"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          echo "ğŸ” Environment Information:"
          node --version
          npm --version
          echo "Operating System: $(uname -a)"
          echo ""
          npm ci --verbose
          npm ls --depth=0
      
      - name: TypeScript compilation check
        run: |
          echo "ğŸ” Checking TypeScript compilation..."
          npx tsc --noEmit
          echo "âœ… TypeScript compilation passed"
        
      - name: ESLint code quality check
        run: |
          echo "ğŸ” Running ESLint checks..."
          npm run lint
          echo "âœ… Code quality checks passed"
      
      - name: Build verification
        run: |
          echo "ğŸ” Testing production build..."
          set -e
          npm run build || { echo "âŒ Build failed"; exit 1; }
          echo "âœ… Production build successful"
        env:
          NEXT_PUBLIC_SUPABASE_URL: https://dummy.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: dummy-key
          SUPABASE_SERVICE_ROLE_KEY: dummy-service-key
          NODE_ENV: test
      
      - name: Unit tests
        run: |
          echo "ğŸ” Running unit tests..."
          set -e
          npm run test:unit -- --verbose --no-cache --runInBand || { echo "âŒ Unit tests failed"; exit 1; }
          echo "âœ… Unit tests passed"
        env:
          NEXT_PUBLIC_SUPABASE_URL: https://dummy.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: dummy-key
          CRON_SECRET: test-cron-secret
          CI: true

      - name: Test coverage check
        if: ${{ inputs.coverage_required }}
        run: |
          echo "ğŸ” Checking test coverage requirements..."
          npm run test:coverage
          echo "âœ… Coverage requirements met"
        env:
          NEXT_PUBLIC_SUPABASE_URL: https://dummy.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: dummy-key
          CRON_SECRET: test-cron-secret

      - name: Full test suite
        if: ${{ inputs.run_all_tests }}
        run: |
          echo "ğŸ” Running comprehensive test suite..."
          npm run test:all
          echo "âœ… All tests passed"
        env:
          NEXT_PUBLIC_SUPABASE_URL: https://dummy.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: dummy-key
          CRON_SECRET: test-cron-secret

      - name: Exchange Rate Sync Tests
        run: |
          echo "ğŸ” Running exchange rate sync tests..."
          npm run test:unit -- --testPathPattern="sync|cron" --verbose
          echo "âœ… Sync tests passed"
        env:
          NEXT_PUBLIC_SUPABASE_URL: https://dummy.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: dummy-key
          CRON_SECRET: test-cron-secret
          CI: true

      - name: Validation Summary
        run: |
          echo "ğŸ§ª Code Validation Complete!"
          echo "âœ… TypeScript compilation verified"
          echo "âœ… Code quality checks passed"  
          echo "âœ… Production build successful"
          echo "âœ… Unit tests passed"
          echo "âœ… Exchange rate sync tests passed"
          echo ""
          echo "ğŸ¯ Your AI-generated code is ready for deployment!"
          echo "Next steps:"
          echo "1. ğŸ—„ï¸ Deploy database changes (if any)"
          echo "2. ğŸš€ Deploy to production"
